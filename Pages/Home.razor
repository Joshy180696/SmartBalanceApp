@page "/home"
@using Microsoft.AspNetCore.Authorization
@using SmartBalanceBlazor.Auth
@using System.Security.Claims
@using static SmartBalanceBlazor.ViewModels.AccountViewModels
@using static SmartBalanceBlazor.ViewModels.ExpenseViewModels
@inject JwtAuthenticationStateProvider AuthProvider
@inject IHttpClientFactory HttpClientFactory
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject NavigationManager Navigation
@attribute [Authorize]

<PageTitle>Calendar - SmartBalance</PageTitle>

<RadzenStack Gap="2rem" Class="rz-p-4 rz-p-md-8">

    <!-- Header -->
    <div class="rz-text-align-center rz-my-6">
        <RadzenText TextStyle="TextStyle.H3" Class="rz-mb-2" Style="color :#3f51b5">
            <b>Calendar Overview</b>
        </RadzenText>
        <RadzenText TextStyle="TextStyle.Subtitle1" Class="rz-opacity-70">
            Welcome, <strong>@username</strong>
        </RadzenText>
    </div>

    <!-- Loading Spinner -->
    @if (isLoading)
    {
        <div class="rz-text-align-center rz-py-16">
            <RadzenProgressBarCircular Size="ProgressBarCircularSize.Large"
                                       ShowValue="false"
                                       Style="width: 80px; height: 80px;" />
            <RadzenText TextStyle="TextStyle.H6" Class="rz-mt-6 rz-display-block" Style="color: #555; font-weight: 500;">
                Loading your calender...
            </RadzenText>
            <div class="loading-dots rz-mt-4">
                <span></span><span></span><span></span>
            </div>
        </div>
    }
    else
    {
        <!-- Income & Balance Card -->
        <RadzenCard Class="rz-shadow-4 rz-border-radius-3">
            <RadzenStack Orientation="Orientation.Horizontal"
                         JustifyContent="JustifyContent.SpaceBetween"
                         AlignItems="AlignItems.Center"
                         Class="rz-p-6">
                <div>
                    <RadzenText TextStyle="TextStyle.Subtitle1" Class="rz-mb-2 rz-opacity-70">
                        Monthly Income
                    </RadzenText>
                    <RadzenText TextStyle="TextStyle.H4" Class="rz-m-0">
                        <b>@($"{monthlyIncome:N0} €")</b>
                    </RadzenText>
                </div>

                <div class="rz-text-align-right">
                    <RadzenText TextStyle="TextStyle.Subtitle1" Class="rz-mb-2 rz-opacity-70">
                        Remaining Balance
                    </RadzenText>
                    <RadzenText TextStyle="TextStyle.H3" Class="rz-m-0"
                                Style="@(TotalBalance >= 0 ? "color: #2e7d32;" : "color: #d32f2f;")">
                        <b>@($"{TotalBalance:N0} €")</b>
                    </RadzenText>
                    @if (TotalBalance < 0)
                    {
                        <RadzenText TextStyle="TextStyle.Body2" Class="rz-mt-2" Style="color: #d32f2f;">
                            You are over budget!
                        </RadzenText>
                    }
                </div>
            </RadzenStack>
        </RadzenCard>

        <!-- No Expenses Message -->
        @if (!expenses.Any())
        {
            <RadzenCard Class="rz-shadow-2 rz-border-radius-3 rz-p-8 rz-text-align-center">
                <RadzenIcon Icon="info" Style="font-size: 3rem; color: #6366f1; opacity: 0.7;" />
                <RadzenText TextStyle="TextStyle.H6" Class="rz-mt-4 rz-mb-2">
                    No expenses this month
                </RadzenText>
                <RadzenText TextStyle="TextStyle.Body1" Class="rz-opacity-70">
                    Click on any day in the calendar to add your first expense!
                </RadzenText>
            </RadzenCard>
        }

        <!-- Calendar -->
        <RadzenCard Class="rz-shadow-3 rz-border-radius-3" Style="overflow: hidden;">
            <RadzenScheduler @ref="scheduler"
                             SlotRender="@OnSlotRender"
                             TItem="Expenses"
                             Data="@expenses"
                             StartProperty="Date"
                             EndProperty="Date"
                             TextProperty="Description"
                             SelectedIndex="2"
                             SlotSelect="@OnSlotSelect"
                             AppointmentSelect="@OnAppointmentSelect"
                             AppointmentRender="@OnAppointmentRender"
                             Style="height: 720px;">

                <RadzenDayView />
                <RadzenWeekView />
                <RadzenMonthView />
            </RadzenScheduler>
        </RadzenCard>
    }
</RadzenStack>

    @code {
    private string username = string.Empty;
    private string userId = string.Empty;
    private decimal monthlyIncome = 0m;
    private RadzenScheduler<Expenses> scheduler = default!;
    private List<Expenses> expenses = new();
    private DateTime currentMonth = DateTime.Now;
    private bool isLoading = true;

    private decimal TotalBalance => monthlyIncome - (expenses?.Sum(e => e.Amount) ?? 0m);

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        StateHasChanged();

        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (!user.Identity?.IsAuthenticated ?? false)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        username = user.FindFirst(c => c.Type == ClaimTypes.Name || c.Type == "unique_name")?.Value ?? "User";
        userId = user.FindFirst(c => c.Type == ClaimTypes.NameIdentifier || c.Type == "sub")?.Value ?? "";

        if (string.IsNullOrEmpty(userId))
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Error", "User not found.");
            Navigation.NavigateTo("/login");
            return;
        }

        await Task.WhenAll(
            LoadMonthlyIncome(),
            FetchExpensesForCurrentMonth()
        );

        isLoading = false;
        StateHasChanged();
    }

    private async Task LoadMonthlyIncome()
    {
        try
        {
            var client = HttpClientFactory.CreateClient("SmartBalanceApi");
            var resp = await client.GetAsync($"api/Account/{userId}");
            if (resp.IsSuccessStatusCode)
            {
                var acc = await resp.Content.ReadFromJsonAsync<AccountResponse>();
                monthlyIncome = acc?.UserAccount?.MonthlyIncome ?? 0m;
            }
        }
        catch
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load mothly income.");
            monthlyIncome = 0;
        }
    }

    private async Task FetchExpensesForCurrentMonth()
    {
        await FetchExpensesForUser(userId, currentMonth);
        if (scheduler != null)
            await scheduler.Reload();
    }

    private async Task FetchExpensesForUser(string userId, DateTime? month = null)
    {
        try
        {
            var client = HttpClientFactory.CreateClient("SmartBalanceApi");
            var url = $"api/Expenses/{userId}";
            if (month.HasValue)
                url += $"?year={month.Value.Year}&month={month.Value.Month}";

            var response = await client.GetAsync(url);

            if (response.IsSuccessStatusCode || response.StatusCode == System.Net.HttpStatusCode.NoContent)
            {
                expenses = await response.Content.ReadFromJsonAsync<List<Expenses>>() ?? new();
                expenses = expenses.Select(e => new Expenses
                {
                    Id = e.Id,
                    Description = e.Description,
                    Amount = e.Amount,
                    Date = new DateTime(e.Date.Year, e.Date.Month, e.Date.Day, 9, 0, 0)
                }).ToList();
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                NotificationService.Notify(NotificationSeverity.Error, "Session expired", "Logging out...");
                await AuthProvider.LogoutAsync();
                Navigation.NavigateTo("/login");
            }
        }
        catch (Exception)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load expenses.");
            expenses = new();
        }
    }
    void OnSlotRender(SchedulerSlotRenderEventArgs args)
    {
        var today = DateTime.Today;
        var currentMonthStart = new DateTime(today.Year, today.Month, 1);

        if (args.Start.Date == today)
            args.Attributes["style"] = "background: rgba(99, 102, 241, 0.15); border-left: 4px solid #6366f1;";

        if (new DateTime(args.Start.Year, args.Start.Month, 1) != currentMonthStart)
            args.Attributes["style"] = "opacity: 0.4; pointer-events: none;";
    }

    async Task OnSlotSelect(SchedulerSlotSelectEventArgs args)
    {
        if (args.Start.Month != DateTime.Now.Month || args.Start.Year != DateTime.Now.Year)
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Not Allowed", "You can only add expenses for the current month.");
            return;
        }

        await DialogService.OpenAsync<AddExpensePage>("Add Expense",
            new Dictionary<string, object> { { "UserId", userId }, { "StartDate", args.Start.Date } },
            new DialogOptions { Width = "420px", Resizable = true, Draggable = true });

        await FetchExpensesForCurrentMonth();
    }

    async Task OnAppointmentSelect(SchedulerAppointmentSelectEventArgs<Expenses> args)
    {
        await DialogService.OpenAsync<ViewExpense>("View Expense",
            new Dictionary<string, object> { { "Expense", args.Data }, { "UserId", userId } },
            new DialogOptions { Width = "420px", Resizable = true });

        await FetchExpensesForCurrentMonth();
    }

    void OnAppointmentRender(SchedulerAppointmentRenderEventArgs<Expenses> args)
    {
        args.Attributes["style"] = "background: #3f51b5; color: white; border-radius: 8px; font-weight: 500;";
        args.Attributes["title"] = $"{args.Data.Description} · {args.Data.Amount:N0} €";
    }
}

<style>
    .rz-scheduler .rz-scheduler-view-month .rz-scheduler-cell-today {
        background: rgba(99, 102, 241, 0.1) !important;
        border: 2px solid #6366f1 !important;
    }

    .loading-dots span {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #6366f1;
        margin: 0 5px;
        animation: dotPulse 1.4s infinite ease-in-out both;
    }

        .loading-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        .loading-dots span:nth-child(3) {
            animation-delay: 0s;
        }

    @@keyframes dotPulse {
        0%, 80%, 100% {
            transform: scale(0.6);
            opacity: 0.5;
        }

        40% {
            transform: scale(1);
            opacity: 1;
        }
    }

    /* Hide the Previous/Next/Today buttons */
    .rz-scheduler-nav-prev-next {
        display: none !important;
    }

    /* Center the month label */
    .rz-scheduler-nav {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    /* Ensure the month label and view buttons are spaced nicely */
    .rz-scheduler-nav-title {
        margin-right: 20px; /* Space between the label and view buttons */
    }

    /* Ensure the scheduler content remains interactive */
    .rz-scheduler-content {
        pointer-events: auto !important;
    }
</style>